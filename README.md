# JOKER

**joker** は、macOS 上で動作する Go 言語ベースのプログラムで、US キーボードにおける左および右の Command キーを単独で押下した際に、それぞれ英数入力およびかな入力に自動で切り替える機能を提供します。さらに、Command キーと他のキー（例：Command + Space）が同時に押下された場合には、入力ソースの切り替えを行いません。反応速度は 50 ミリ秒に設定されており、迅速な入力ソースの切り替えを実現します。

## 特徴

- **単独押下検出**: 左 Command キーを単独で押すと英数入力に、右 Command キーを単独で押すとかな入力に切り替わります。
- **併用時の無効化**: Command キーと他のキーを併用した場合、入力ソースの切り替えを行いません。
- **高速反応**: 反応速度を 50 ミリ秒に設定し、迅速な入力ソースの切り替えを実現。
- **シンプルな実装**: Go 言語と Cgo を用いて、macOS のネイティブ API を活用。

## 必要条件

- **macOS**: このプログラムは macOS 上でのみ動作します。
- **Go 言語**: [Go](https://golang.org/) のインストールが必要です。
- **Cgo サポート**: Cgo を使用するため、Xcode のコマンドラインツールがインストールされている必要があります。
- **アクセシビリティ権限**: キーイベントを監視するために、アクセシビリティの権限が必要です。

## インストール手順

### 1. Go のインストール

Go がインストールされていない場合は、[公式サイト](https://golang.org/dl/)からインストーラーをダウンロードしてインストールしてください。

### 2. Xcode コマンドラインツールのインストール

ターミナルを開き、以下のコマンドを実行して Xcode のコマンドラインツールをインストールします。

```sh
xcode-select --install
```

### 3. リポジトリのクローン

プロジェクトをクローンします。

```sh
git clone https://github.com/shuyaeer/joker.git
cd joker
```

※リポジトリの URL は適宜変更してください。

## ビルド手順

### 1. 依存関係の確認

このプロジェクトは Cgo を使用しているため、C コンパイラが必要です。通常、Xcode コマンドラインツールのインストールで解決します。

### 2. ビルド

プロジェクトのルートディレクトリで以下のコマンドを実行してビルドします。

```sh
go build -o joker main.go
```

ビルドが成功すると、`joker` という実行ファイルが生成されます。

## インストール via `go install`

このプログラムは、`go install` コマンドを使用して簡単にインストールすることもできます。以下の手順に従ってください。

### 手順

1. **Go のインストール**

   Go がインストールされていない場合は、[公式サイト](https://golang.org/dl/)からインストーラーをダウンロードしてインストールしてください。

2. **Xcode コマンドラインツールのインストール**

   ターミナルを開き、以下のコマンドを実行して Xcode のコマンドラインツールをインストールします。

   ```sh
   xcode-select --install
   ```

3. **プログラムのインストール**

   以下のコマンドを実行して、プログラムをインストールします。`@latest` は最新バージョンをインストールします。

   ```sh
   go install github.com/shuyaeer/joker@latest
   ```

   インストールが成功すると、`$GOPATH/bin` または `$HOME/go/bin` に実行ファイルが配置されます。`$GOPATH/bin` が PATH に含まれていることを確認してください。PATH に含まれていない場合は、以下のコマンドを実行して追加します。

   ```sh
   export PATH=$PATH:$HOME/go/bin
   ```

   この設定を永続化するために、`~/.bash_profile` や `~/.zshrc` などのシェル設定ファイルに追加してください。

4. **実行**

   以下のコマンドでプログラムを実行します。

   ```sh
   joker
   ```

## 実行手順

### 1. アクセシビリティ権限の付与

初めて実行する際には、macOS の「セキュリティとプライバシー」設定でアクセシビリティ権限を付与する必要があります。

- **手順**:
  1. **システム環境設定**を開く。
  2. **セキュリティとプライバシー**を選択。
  3. **プライバシー**タブを選択。
  4. 左側のリストから**アクセシビリティ**を選択。
  5. 鍵アイコンをクリックして変更を加えるために認証する。
  6. 実行ファイル（例: `joker`）をリストに追加し、チェックを入れる。

### 2. プログラムの実行

ビルド後、以下のコマンドでプログラムを実行します。

```sh
./joker
```

または、`go install` でインストールした場合は以下のコマンドを実行します。

```sh
joker
```

実行すると、ターミナルに「Starting key tap...」と表示され、バックグラウンドでキーイベントの監視が開始されます。

## 使用方法

- **左 Command キーを単独で押す**:

  - 英数入力に切り替わります。

- **右 Command キーを単独で押す**:

  - かな入力に切り替わります。

- **Command キーと他のキーを併用して押す（例: Command + Space）**:
  - 入力ソースの切り替えは行われません。

## 動作確認

- **単独押下の確認**:
  左 Command キーと右 Command キーをそれぞれ単独で押し、期待通りに入力ソースが切り替わることを確認してください。

- **併用時の確認**:
  Command キーと他のキー（例: Space）を同時に押しても、入力ソースが切り替わらないことを確認してください。

## トラブルシューティング

- **イベントタップの作成に失敗する**:

  - アクセシビリティ権限が正しく設定されているか確認してください。権限が不足していると、プログラムはイベントタップの作成に失敗し、エラーメッセージを表示します。

- **入力ソースの切り替えが機能しない**:

  - システムに指定された入力ソース（英数: `en-US`、かな: `ja-JP`）が存在することを確認してください。必要に応じて、`switchToEnglish` および `switchToJapanese` 関数内の入力ソース識別子を調整してください。

- **ビルドエラーが発生する**:
  - Go、Cgo、Xcode コマンドラインツールが正しくインストールされていることを確認してください。
  - プロジェクトの依存関係が正しく設定されているか確認してください。

## カスタマイズ

- **タイマー期間の調整**:
  デフォルトでは、タイマー期間は 50 ミリ秒に設定されています。反応速度をさらに速めたい場合や、逆に誤判定を減らしたい場合は、`main.go` 内の `TIMER_DURATION` を変更してください。

  ```c
  #define TIMER_DURATION 50 * NSEC_PER_MSEC // 50ミリ秒
  ```

  例として、30 ミリ秒に変更する場合:

  ```c
  #define TIMER_DURATION 30 * NSEC_PER_MSEC // 30ミリ秒
  ```

  ※タイマー期間を短くしすぎると、誤判定が増える可能性があります。最適な値を見つけるためにテストを行ってください。

## ライセンス

このプロジェクトは MIT ライセンスのもとで提供されています。詳細については、[LICENSE](LICENSE) ファイルを参照してください。

## 貢献

バグ報告や機能追加の提案、プルリクエストなど、貢献は大歓迎です。プロジェクトをフォークし、変更を加えてからプルリクエストを送信してください。

## 作者

[あなたの名前](https://github.com/shuyaeer)

---

**注意**: このプログラムはシステムの入力ソース設定を変更します。使用する際は、事前に入力ソースのバックアップを取るなど、必要な対策を講じてください。

## 追加情報

### `go install` でのインストールについて

`go install` コマンドを使用することで、リポジトリをクローンせずに直接プログラムをインストールすることができます。以下のコマンドを実行してください。

```sh
go install github.com/shuyaeer/joker@latest
```

- `@latest` は最新バージョンをインストールします。特定のバージョンをインストールしたい場合は、バージョン番号を指定してください（例: `@v1.0.0`）。

インストール後、実行ファイルは `$GOPATH/bin` または `$HOME/go/bin` に配置されます。`$GOPATH/bin` が PATH に含まれていることを確認してください。含まれていない場合は、以下のコマンドを実行して PATH を更新します。

```sh
export PATH=$PATH:$HOME/go/bin
```

この設定を永続化するために、シェルの設定ファイル（例: `~/.bash_profile`, `~/.zshrc`）に追加してください。

### `go install` の利点

- **簡単なインストール**: リポジトリを手動でクローンしてビルドする必要がありません。
- **自動アップデート**: `go install` を再度実行することで、最新バージョンに簡単にアップデートできます。
- **一貫性**: Go モジュールの管理と一貫しているため、依存関係の管理が容易です。

### 例: `go install` の実行

以下は、`go install` を使用してプログラムをインストールし、実行する手順の例です。

```sh
# インストール
go install github.com/shuyaeer/joker@latest

# PATH を更新（必要な場合）
export PATH=$PATH:$HOME/go/bin

# プログラムの実行
joker
```

これにより、リポジトリをクローンする手間を省き、簡単にプログラムをインストールおよび実行することができます。

---

ご不明な点や追加の要望がありましたら、遠慮なくお知らせください。
